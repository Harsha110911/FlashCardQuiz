<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSM Before - Flash Card Quiz</title>
<style>
html, body { margin:0; padding:0; width:100%; height:100%; background:black; font-family:Arial,sans-serif; overflow:hidden; }
canvas { display:block; }

#beforeScreen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; z-index:100; }
.cinematic-panel { background:white; border-radius:80px; padding:50px 70px; max-width:750px; text-align:center; box-shadow:0 10px 35px rgba(0,0,0,0.35); }
.cinematic-text { font-size:18px; line-height:1.8; margin:10px 0; text-align:left; color:black; }

.button { position: relative; transition: all 0.3s ease-in-out; box-shadow:0px 10px 20px rgba(0,0,0,0.2); padding:0.5rem 1.25rem; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; gap:10px; font-weight:bold; border:3px solid #ffffff4d; outline-offset:3px; overflow:hidden; font-size:15px; cursor:pointer; margin-top:25px; user-select:none; display:none; }
#backBtn { background-color: #e74c3c; color:white; }
#startQuizBtn { background-color: rgb(0 107 179); color:white; }
.button:hover { transform: scale(1.05); border-color:#fff9; }
.button::before { content:""; position:absolute; width:100px; height:100%; background-image: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.8), rgba(255,255,255,0) 70%); top:0; left:-100px; opacity:0.6; }
.button:hover::before { animation: shine 1.5s ease-out infinite; }
@keyframes shine {0%{left:-100px;} 60%{left:100%;} to{left:100%;} }

/* --- Start of Roll Number Modal Styles --- */
#rollModal { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:200; display:none; }
.roll-box { background:#fff; padding:30px 40px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.4); }
.roll-box h2 { margin-bottom:15px; color:#333; }
.roll-box input { padding:10px; border-radius:8px; border:2px solid #ccc; width:80%; font-size:16px; margin-bottom:15px; }
.roll-box button { background:#006bb3; color:white; border:none; padding:10px 20px; border-radius:999px; font-weight:bold; cursor:pointer; position: relative; overflow:hidden; margin-top:10px; }
.roll-box button::before { content:""; position:absolute; width:100px; height:100%; background-image: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.8), rgba(255,255,255,0) 70%); top:0; left:-100px; opacity:0.6; }
.roll-box button:hover::before { animation: shine 1.5s ease-out infinite; }
#userDetails { margin-top:15px; font-weight:bold; color:#333; }
#proceedBtn { display:none; margin-top:10px; }
/* --- End of Roll Number Modal Styles --- */
</style>
</head>
<body>
<canvas id="csm"></canvas>

<div id="beforeScreen">
  <div class="cinematic-panel">
    <h1 id="cinematicHeading"></h1>
    <div id="rulesContainer"></div>
    <div style="display:flex; gap:15px; justify-content:center; margin-top:25px;">
      <button class="button" id="backBtn">← Back</button>
      <button class="button" id="startQuizBtn">Start Quiz →</button>
    </div>
  </div>
</div>

<!-- --- Roll Number Modal --- -->
<div id="rollModal">
  <div class="roll-box">
    <h2>Enter Your Roll Number</h2>
    <input type="text" id="rollInput" placeholder="e.g. 24F11A0540" />
    <br/>
    <button id="submitRollBtn">Submit</button>
    <button id="proceedBtn">Proceed to Quiz →</button>
    <p id="userDetails"></p>
  </div>
</div>

<!-- ✅ Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Initialize Supabase
const supabaseUrl = "https://vjbdemwrqalpnjbjfsir.supabase.co";   // ⬅️ Replace with your Supabase project URL
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqYmRlbXdycWFscG5qYmpmc2lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMjEzODgsImV4cCI6MjA3MTc5NzM4OH0.yigzQuQcI-MbHSYV04MZFoCp9iAYcIF2cGO2VMFgdfs";                     // ⬅️ Replace with your anon/public API key
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Background Animation (Neural Net)
(() => {
  const canvas = document.getElementById('csm');
  const ctx = canvas.getContext('2d');
  let width, height, nodes=[], hue=200;

  function resizeCanvas(){
    width=canvas.width=window.innerWidth;
    height=canvas.height=window.innerHeight;
    nodes=[];
    for(let i=0;i<80;i++){
      nodes.push({x:Math.random()*width, y:Math.random()*height, vx:(Math.random()-0.5)*0.7, vy:(Math.random()-0.5)*0.7, radius:2+Math.random()*2});
    }
  }

  function draw(){
    ctx.fillStyle="rgba(0,0,0,0.15)";
    ctx.fillRect(0,0,width,height);
    hue=(hue+1.2)%360;
    const color=`hsl(${hue},100%,60%)`;

    for(let i=0;i<nodes.length;i++){
      for(let j=i+1;j<nodes.length;j++){
        const dx=nodes[i].x-nodes[j].x;
        const dy=nodes[i].y-nodes[j].y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<120){
          ctx.strokeStyle=color;
          ctx.globalAlpha=1-dist/120;
          ctx.lineWidth=1;
          ctx.beginPath();
          ctx.moveTo(nodes[i].x,nodes[i].y);
          ctx.lineTo(nodes[j].x,nodes[j].y);
          ctx.stroke();
        }
      }
    }

    ctx.globalAlpha=1;
    nodes.forEach(node=>{
      ctx.fillStyle=color;
      ctx.beginPath();
      ctx.arc(node.x,node.y,node.radius,0,Math.PI*2);
      ctx.fill();
      node.x+=node.vx; node.y+=node.vy;
      if(node.x<0||node.x>width) node.vx*=-1;
      if(node.y<0||node.y>height) node.vy*=-1;
    });
  }

  function animate(){ draw(); requestAnimationFrame(animate); }
  window.addEventListener('resize',resizeCanvas);
  resizeCanvas(); animate();
})();

// Rules typing
window.onload = function(){
  const heading = document.getElementById('cinematicHeading');
  const rulesContainer = document.getElementById('rulesContainer');
  const startBtn = document.getElementById('startQuizBtn');
  const backBtn = document.getElementById('backBtn');

  const rules=[
    "1. The user will have five questions.",
    "2. For each correct answer, the player will be awarded 2 points.",
    "3. For each incorrect answer, no points will be awarded."
  ];

  function typeWriter(el,text,speed,cb){
    el.innerHTML=''; let i=0;
    function typing(){
      if(i<text.length){ el.innerHTML+=text.charAt(i); i++; setTimeout(typing,speed); }
      else if(cb) cb();
    }
    typing();
  }

  typeWriter(heading,"Before We Begin",100,function showRules(){
    let index=0;
    function nextRule(){
      if(index<rules.length){
        const p=document.createElement('p');
        p.className='cinematic-text';
        rulesContainer.appendChild(p);
        typeWriter(p,rules[index],40,()=>{index++; setTimeout(nextRule,300);});
      } else { startBtn.style.display='inline-flex'; backBtn.style.display='inline-flex'; }
    }
    nextRule();
  });

  backBtn.onclick = () => {
    window.location.href = "departments.html";
  };

  // Roll Number Modal
  const rollModal = document.getElementById('rollModal');
  const rollInput = document.getElementById('rollInput');
  const submitBtn = document.getElementById('submitRollBtn');
  const proceedBtn = document.getElementById('proceedBtn');
  const userDetails = document.getElementById('userDetails');

  startBtn.onclick = ()=> rollModal.style.display = "flex";

  // Submit Roll → Check DB
  submitBtn.onclick = async () => {
    const roll = rollInput.value.trim().toUpperCase();
    if(!roll){ alert("Please enter your roll number."); return; }

    // Check if user exists
    const { data: existing, error: selectError } = await supabase
      .from("users")
      .select("*")
      .eq("roll_number", roll)
      .single();

    if (selectError && selectError.code !== "PGRST116") {
      console.error("Select error:", selectError);
      alert("Error checking user.");
      return;
    }

    if (!existing) {
      // Insert new user
      const { error: insertError } = await supabase
        .from("users")
        .insert([{ roll_number: roll, points: 0, attempts: 0 }]);

      if(insertError){
        console.error("Insert error:", insertError);
        alert("Error creating user.");
        return;
      }
      userDetails.textContent = `Roll Number: ${roll} | Points: 0 | Attempts: 5`;
    } else {
      userDetails.textContent = `Roll Number: ${roll} | Points: ${existing.points} | Attempts: ${existing.attempts}`;
    }

    proceedBtn.style.display = "inline-block";
  };

  proceedBtn.onclick = () => {
    localStorage.setItem("rollNumber", rollInput.value.trim().toUpperCase());
    window.location.href = "csm-quiz.html";
  };

  rollInput.addEventListener("keydown", (e) => { if(e.key==="Enter") submitBtn.click(); });
};
</script>
</body>
</html>
