<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSE Hex Rain Quiz</title>
<style>
  html, body { margin:0; padding:0; height:100%; width:100%; background:black; overflow:hidden; font-family:'Poppins',sans-serif; }
  canvas { display:block; }

  #beforeScreen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; pointer-events:none; }
  .cinematic-panel { position:relative; background:white; border-radius:80px; padding:50px 70px; max-width:750px; text-align:center; pointer-events:auto; box-shadow:0 10px 35px rgba(0,0,0,0.35); }
  .cinematic-text { font-size:18px; line-height:1.8; margin:10px 0; text-align:left; }

  .button { position:relative; transition:all 0.3s ease-in-out; box-shadow:0px 10px 20px rgba(0,0,0,0.2); padding:0.5rem 1.25rem; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; gap:10px; font-weight:bold; border:3px solid #ffffff4d; outline-offset:3px; overflow:hidden; font-size:15px; cursor:pointer; margin-top:25px; user-select:none; display:none; }
  #backBtn { background-color:#e74c3c;color:white; }
  #startQuizBtn { background-color:rgb(0 107 179); color:white; }
  .button:hover { transform:scale(1.05); border-color:#fff9; }
  .button::before { content:""; position:absolute; width:100px; height:100%; background-image:linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.8), rgba(255,255,255,0) 70%); top:0; left:-100px; opacity:0.6; }
  .button:hover::before { animation: shine 1.5s ease-out infinite; }
  @keyframes shine { 0%{left:-100px;} 60%{left:100%;} to{left:100%;} }

  /* --- Start of Roll Number Modal Styles --- */
  #rollModal { position: fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:200; display:none; }
  .roll-box { background:#fff; padding:30px 40px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.4); }
  .roll-box h2 { margin-bottom:15px; color:#333; }
  .roll-box input { padding:10px; border-radius:8px; border:2px solid #ccc; width:80%; font-size:16px; margin-bottom:15px; }
  .roll-box button { background:#006bb3; color:white; border:none; padding:10px 20px; border-radius:999px; font-weight:bold; cursor:pointer; position: relative; overflow:hidden; margin-top:10px; }
  .roll-box button::before { content:""; position:absolute; width:100px; height:100%; background-image: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.8), rgba(255,255,255,0) 70%); top:0; left:-100px; opacity:0.6; }
  .roll-box button:hover::before { animation: shine 1.5s ease-out infinite; }
  #userDetails { margin-top:15px; font-weight:bold; color:#333; }
  #proceedBtn { display:none; margin-top:10px; }
  /* --- End of Roll Number Modal Styles --- */
</style>
</head>
<body>
<canvas id="matrix"></canvas>

<div id="beforeScreen">
  <div class="cinematic-panel">
    <h1 id="cinematicHeading"></h1>
    <div id="rulesContainer"></div>
    <div style="display:flex; gap:15px; justify-content:center; margin-top:25px;">
      <button class="button" id="backBtn">← Back</button>
      <button class="button" id="startQuizBtn">Start Quiz →</button>
    </div>
  </div>
</div>

<!-- --- Start of Roll Number Modal HTML --- -->
<div id="rollModal">
  <div class="roll-box">
    <h2>Enter Your Roll Number</h2>
    <input type="text" id="rollInput" placeholder="e.g. 24F11A05XX" />
    <br/>
    <button id="submitRollBtn">Submit</button>
    <button id="proceedBtn">Proceed to Quiz →</button>
    <p id="userDetails"></p>
  </div>
</div>
<!-- --- End of Roll Number Modal HTML --- -->

<!-- Supabase Client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- Supabase setup ---
const supabaseUrl = "https://vjbdemwrqalpnjbjfsir.supabase.co"; // your project URL
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqYmRlbXdycWFscG5qYmpmc2lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMjEzODgsImV4cCI6MjA3MTc5NzM4OH0.yigzQuQcI-MbHSYV04MZFoCp9iAYcIF2cGO2VMFgdfs"; 
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// --- Hex Rain Background ---
(() => {
  const canvas = document.getElementById('matrix');
  const ctx = canvas.getContext('2d');
  const fontSize = 14;
  let columns, drops, hue = 0;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    columns = Math.floor(canvas.width / fontSize);
    drops = new Array(columns).fill(1);
  }

  function draw() {
    ctx.fillStyle = 'rgba(0,0,0,0.1)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.font = fontSize+'px monospace';
    const gradient = ctx.createLinearGradient(0,0,canvas.width,0);
    gradient.addColorStop(0, `hsl(${hue},100%,50%)`);
    gradient.addColorStop(1, `hsl(${(hue+60)%360},100%,50%)`);
    ctx.fillStyle = gradient;

    const chars = '0123456789ABCDEF';
    for(let i=0;i<drops.length;i++){
      const text = chars.charAt(Math.floor(Math.random()*chars.length));
      ctx.fillText(text,i*fontSize,drops[i]*fontSize);
      if(drops[i]*fontSize > canvas.height && Math.random()>0.975) drops[i]=0;
      drops[i]+=1;
    }
    hue = (hue+0.5)%360;
  }

  function animate(){ draw(); requestAnimationFrame(animate); }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();
  animate();
})();

// --- Cinematic "Before We Begin" with Rules ---
window.onload = function() {
  const heading = document.getElementById('cinematicHeading');
  const rulesContainer = document.getElementById('rulesContainer');
  const startBtn = document.getElementById('startQuizBtn');
  const backBtn = document.getElementById('backBtn');

  const rules = [
   "1. The user will have five questions.",
  "2. For each correct answer, the player will be awarded 2 points.",
  "3. For each incorrect answer, no points will be awarded."
  ];

  function typeWriter(el, text, speed, cb) {
    el.innerHTML = '';
    let i = 0;
    function typing() {
      if(i < text.length) { el.innerHTML += text.charAt(i); i++; setTimeout(typing, speed); }
      else if(cb) cb();
    }
    typing();
  }

  typeWriter(heading, "Before We Begin", 100, showRules);

  function showRules() {
    let index = 0;
    function nextRule() {
      if(index < rules.length) {
        const p = document.createElement('p');
        p.className = 'cinematic-text';
        rulesContainer.appendChild(p);
        typeWriter(p, rules[index], 40, () => { index++; setTimeout(nextRule, 300); });
      } else {
        startBtn.style.display = 'inline-flex';
        backBtn.style.display = 'inline-flex';
      }
    }
    nextRule();
  }

  // --- Button Actions ---
  backBtn.onclick = () => {
    window.location.href = "departments.html"; // Redirect to departments selection page
  };
  startBtn.onclick = () => document.getElementById('rollModal').style.display = "flex";

  // --- Roll Number Modal with Supabase ---
  const rollInput = document.getElementById('rollInput');
  const submitBtn = document.getElementById('submitRollBtn');
  const proceedBtn = document.getElementById('proceedBtn');
  const userDetails = document.getElementById('userDetails');
  let currentRollNumber = "";

  submitBtn.onclick = async () => {
    const roll_number = rollInput.value.trim().toUpperCase();
    if(!roll_number){ alert("Please enter your roll number."); return; }
    currentRollNumber = roll_number;

    // Check if user exists
    let { data, error } = await supabase.from("users").select("*").eq("roll_number", roll_number).limit(1);
    if(error){ alert("Database Error: " + error.message); return; }

    if(!data || data.length === 0){
      // New user → Insert default record
      const { error: insertError } = await supabase.from("users").insert([{ roll_number: roll_number, points: 0, attempts: 5 }]);
      if(insertError){ alert("Insert Error: " + insertError.message); return; }
      userDetails.textContent = `Roll Number: ${roll_number} | Points: 0 | Attempts: 5`;
    } else {
      // Existing user
      userDetails.textContent = `Roll Number: ${roll_number} | Points: ${data[0].points} | Attempts: ${data[0].attempts}`;
    }

    proceedBtn.style.display = "inline-block";
  };

  proceedBtn.onclick = () => {
    if(!currentRollNumber){ alert("Please submit your roll number first!"); return; }
    localStorage.setItem("rollNumber", currentRollNumber);
    window.location.href = "cse-quiz.html"; // Replace with your actual quiz page
  };

  rollInput.addEventListener("keydown", (e) => { if(e.key==="Enter") submitBtn.click(); });
};
</script>
</body>
</html>

